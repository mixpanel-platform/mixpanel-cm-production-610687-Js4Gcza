<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <h1>A/B Test: Experiment Detail</h1>
    <div id="experiment">
      <div class="left">
        <p>Experiment (People Property Name)</p>
        <div id="people-prop-select"></div>
      </div>
      <div class="middle">
        <p>Experiment Name (Event Property)</p>
        <div id="event-prop-select"></div>
      </div>
      <div class="right">
        <p>Baseline</p>
        <div id="baseline-select"></div>
      </div>
      <br><br><br><hr><br>
      <div class="conversion">
        <p>Conversion Event 1</p>
        <div id="conversion-event-a"></div>
        <div class="select where a mixpanel-platform-label">where</div>
        <div class="select prop" id="conversion-prop-a"></div>
        <div class="select contains a"></div>
        <div class="select prop" id="conversion-prop-value-a"></div>
        <div class="start a"></div>
        <div class="report" id="table-a"></div>
        <h2 class="improvement a">Improvement over time</h2>
        <div class="report" id="funnel-a"></div>
      </div>
      <br><hr><br>
      <div class="conversion">
        <p>Conversion Event 2</p>
        <div id="conversion-event-b"></div>
        <div class="select where b mixpanel-platform-label">where</div>
        <div class="select prop" id="conversion-prop-b"></div>
        <div class="select contains b"></div>
        <div class="select prop" id="conversion-prop-value-b"></div>
        <div class="start a"></div>
        <div class="report" id="table-b"></div>
        <h2 class="improvement b">Improvement over time</h2>
        <div class="report" id="funnel-b"></div>
      </div>
    </div>
    <style>
      body {
        color: rgb(95,105,131);
      }
      h1 {
        font-size: 22px;
        margin-bottom: 16px;
      }
      p {
        font-size: 13px;
        font-weight: bold;
      }
      .left, .middle, .right {
        width: 30%;
        display: inline-block;
      }
      .select {
        margin: 15px 15px 0 0;
      }
      .where {
        line-height: 33px;
      }
      .where, .contains {
        display: none;
      }
      .report {
        margin: 15px 0 0;
      }
      .start, .improvement {
        display: none;
      }
      .improvement {
        margin-top: 15px;
      }
    </style>
    <script>
      // LDB NOTES
      // nice to haves: duration (first time experiment viewed with that experiment name property was fired) and retention (has that person also paid in the last 30 days)
      
      // summary report: Maybe it just keys off of the primary conversion goal and shows something like experiment name, conversion rate, certainty, and improvement (I think this is pretty similar to what Optimizely does).
      
      // monetization is currently tracking average first payment and lifetime revenue *of everyone in the experiment* not just people who paid. do we want only those who have paid?

      MP.api.setCredentials('68b81fb0afb02354b0a977997f849628', '549b821284a202ce211c0c1befb60c31');
    
      var numExperiments = 0,
          peopleProps = {
            items: [
              {label: "-- Select experiment name --", value: "select"}
            ]
          },
          eventPropValues = {
            items: [
              {label: '-- Select experiment name --', value: "select"}
            ]
          },
          baselineValues = {
            items: [
              {label: '-- Select baseline --', value: "select"}
              ]
          },
          queryOptions = {
            items: [
              {label: 'contains', value: 'contains'},
              {label: 'does not contain', value: 'does not contain'},
              {label: 'equals', value: 'equals'},
              {label: 'does not equal', value: 'does not equal'},
              {label: 'is set', value: 'is set'},
              {label: 'is not set', value: 'is not set'}
              ]
          },
          propVals = {},
          propVals2 = {},
          eventParams = {},
          eventParams2 = {},
          experimentSelect = '',
          eventSelect = '',
          baselineSelect ='',
          conversionSelects = [],
          propertySelects = [],
          queries = [],
          propValueSelects = [],
          funnelSelects = [],
          tableSelects = [];
          
      function addExperiment() {

        // query People to create the dropdown of people properties
        MP.api.query('/api/2.0/engage/properties').done(function(json) {
          for (property in json.results) {
            peopleProps.items.push({label: property, value: property});
          }
          experimentSelect = $('#people-prop-select').MPSelect(peopleProps);
        });
        
        // query property values for experiment names on the Experiment Viewed event to create dropdown of event properties
        eventParameters = {event: "App - Experiment Enrolled", name: "experiment_name", limit: 255}
        MP.api.query('api/2.0/events/properties/values', eventParameters).done(function(array) {
          for (property in array) {
            eventPropValues.items.push({label: array[property], value: array[property]});
          }
          eventSelect = $('#event-prop-select').MPSelect(eventPropValues);
        });
        
        // set baseline dropdown
        variantParameters = {event: 'App - Experiment Enrolled', name: 'variation_name', limit: 255}
        MP.api.query('api/2.0/events/properties/values', variantParameters).done(function(array) {
          for (variant in array) {
            baselineValues.items.push({label: array[variant], value: array[variant]});
          }
          baselineSelect = $('#baseline-select').MPSelect(baselineValues);
        });
        
        // create event dropdowns
        conversionSelects['a'] = $('#conversion-event-a').MPEventSelect();
        conversionSelects['b'] = $('#conversion-event-b').MPEventSelect();

        // create property dropdowns
        propertySelects['a'] = $('#conversion-prop-a').MPPropertySelect();
        propertySelects['b'] = $('#conversion-prop-b').MPPropertySelect();
        
        // set up funnel graphs (will show conversion rates over time)
        funnelSelects['a'] = $('#funnel-a').MPChart({chartType: 'line'});
        funnelSelects['b'] = $('#funnel-b').MPChart({chartType: 'line'});

        // set up tables
        tableSelects['a'] = $('#table-a').MPTable();
        tableSelects['b'] = $('#table-b').MPTable();

      }
      
      function calcStats(total0, success0, total1, success1) {
        
        var conv0 = success0 / total0,
            conv1 = success1 / total1;

        if ( isNaN(conv1) || isNaN(conv0) ) {
          var variant_stats = ['N/A', '', 'N/A', '']
        }
        else if ( conv0 == 0 ) {
          var variant_stats = ['Conversion of original cannot equal 0', '', 'N/A', ''];
        }
        else {
          var improvement = (conv1 - conv0) / conv0;
          if (isNaN(improvement) || improvement == Infinity) {
            $.noop();
          }
          else {
            improvement = (improvement * 100).toFixed(1) + '%';
            if (improvement > 0) {
              console.log('yes');
              improvement = '+' + improvement;
            }
          }
          
          var se0 = Math.sqrt(conv0*(1-conv0)/total0),
              se1 = Math.sqrt(conv1*(1-conv1)/total1),
              ci = '(Â±' + (1.96 * se1).toFixed(2) + '%)',
              zscore = ((conv1 - conv0) / Math.sqrt(Math.pow(se1,2) + Math.pow(se0,2))),
              // the following is from http://picomath.org/javascript/phi.js.html
              // constants
              a1 = 0.254829592,
              a2 = -0.284496736,
              a3 =  1.421413741,
              a4 = -1.453152027,
              a5 =  1.061405429,
              p  =  0.3275911;

          // save the sign of zscore
          var sign = 1;
          if (zscore < 0) {
            sign = -1
          }
          zscore = Math.abs(zscore)/Math.sqrt(2.0);
          
          var t = 1.0/(1.0 + p*zscore);
          var y = 1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*Math.exp(-zscore*zscore);
          
          var chance = 0.5*(1.0 + sign*y),
              result = '--';
          
          if (total1 < 10) {
            chance = 'Sample size too small'
          }
          else if (chance >= 0.95) {
            result = 'Win'
          }
          else if (chance <= 0.05) {
            result = 'Lose'
          }
          else if (0.95 > chance > 0.05) {
            result = 'Not Significant'
          }
          
          if (isNaN(chance)) {
            $.noop();
          }
          else {
            chance = (chance * 100).toFixed(1) + '%';
          }
          
          var variant_stats = [improvement, ci, chance, result];
        }
        
        return variant_stats;
        
      }
      
      function populatePropValues(property) {
        
      }
      
      function runQuery(event) {
        var experiment = experimentSelect.MPSelect('value'),
            experimentEvent = eventSelect.MPSelect('value'),
            baseline = baselineSelect.MPSelect('value'),
            conversionEvent = conversionSelects[event].MPEventSelect('value'),
            conversionProp = propertySelects[event].MPPropertySelect('value'),
            people = {};
        if (propValueSelects[event]) {
          var conversionPropQuery = queries[event].MPSelect('value'),
              conversionPropValue = propValueSelects[event].MPSelect('value');
        }
            
        people['total'] = {'count': 0, 'first': 0.00, 'lifetime': 0.00}
            
        MP.api.people().done(function(json) {

          parameters = {'session_id': json.values().session_id, 'page': 0};
          has_results = true;
          
          profiles = json.values().results;
          for (var profile in profiles) {
            if (profiles.hasOwnProperty(profile)) {
              if (profiles[profile].$properties.hasOwnProperty(experiment)) {
                
                people['total']['count'] += 1;

                var distinct = profiles[profile].$distinct_id,
                    experimentValue = profiles[profile].$properties[experiment];
                    
                if (people[experimentValue]) { 
                  people[experimentValue]['count'] += 1;
                }
                else {
                  people[experimentValue] = {'count': 1, 'first': 0.00, 'lifetime': 0.00};
                }
                
                if (profiles[profile].$properties.hasOwnProperty('First Payment Amount')) {
                  var firstRevenue = profiles[profile].$properties['First Payment Amount'];
                  people[experimentValue]['first'] += firstRevenue;
                  people['total']['first'] += firstRevenue;
                }
                if (profiles[profile].$properties.hasOwnProperty('Lifetime Revenue')) {
                  var lifeRevenue = profiles[profile].$properties['Lifetime Revenue'];
                  people[experimentValue]['lifetime'] += lifeRevenue;
                  people['total']['lifetime'] += lifeRevenue;
                }

              }
            }
          }
          
        });
        
        var funnelParameters = {
              // from: '',
              // to: '',
              segment: 'variation_name',
              where: ''
            };
          
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth()+1; // January is 0
        var yyyy = today.getFullYear();
        
        if(dd<10) {
            dd='0'+dd
        } 
        
        if(mm<10) {
            mm='0'+mm
        } 
        
        today = yyyy+'-'+mm+'-'+dd;
        
        var durationParameters = {
              from_date: '2015-06-01',
              to_date: today,
              event: 'Experiment Viewed', 
              where: '"' + experimentEvent + '" in properties["experiment_name"]'
            };
        // MP.api.query('https://data.mixpanel.com/api/2.0/export', durationParameters).done(function(json) {
        //   console.log(json);
        //   funnelParameters.from = '';
        //   funnelParameters.to = '';
        // });
        
        // define selector for conversion event in funnel based on query dropdown
        if (conversionPropQuery == 'contains') {
          funnelParameters.where = '"' + conversionPropValue + '" in string(properties["' + conversionProp + '"])'
        }
        else if (conversionPropQuery == 'does not contain') {
          funnelParameters.where = 'not "' + conversionPropValue + '" in string(properties["' + conversionProp + '"])'
        }
        else if (conversionPropQuery == 'equals') {
          funnelParameters.where = '(string(properties["' + conversionProp + '"]) == "' + conversionPropValue + '")'
        }
        else if (conversionPropQuery == 'does not equal') {
          funnelParameters.where = '(string(properties["' + conversionProp + '"]) != "' + conversionPropValue + '")'
        }
        else if (conversionPropQuery == 'is set') {
          funnelParameters.where = 'defined (properties["' + conversionProp + '"])'
        }
        else if (conversionPropQuery == 'is not set') {
          funnelParameters.where = 'not defined (properties["' + conversionProp + '"])'
        }
        
        // query Mixpanel for funnel information and transform it to populate the graph and table
        MP.api.funnel({'event': 'App - Experiment Enrolled', 'selector': 'properties["experiment_name"] == "' + experimentEvent + '"'}, conversionEvent, funnelParameters).done(function(results) {
          var funnelObject = {},
              abObject = {},
              tableObject = {};
              
          for (variant in results) {
            funnelObject[variant] = {};
            tableObject[variant] = {'*Experiment Viewed':0};
            tableObject[variant][conversionEvent] = 0;
            
            for (date in results[variant]) {
              funnelObject[variant][date] = {1: results[variant][date][0].count, 2: results[variant][date][1].count}
              tableObject[variant]['*Experiment Viewed'] += results[variant][date][0].count;
              tableObject[variant][conversionEvent] += results[variant][date][1].count;
            }
            var conversion = tableObject[variant][conversionEvent] / tableObject[variant]['*Experiment Viewed'];
            if (!isNaN(conversion)) {
              tableObject[variant]['~Conversion'] = (conversion * 100).toFixed(2) + '%';
            }
            else {
              tableObject[variant]['~Conversion'] = 'N/A';
            }
          }
          
          var startDate = [];
          
          // for each variant:
          // take all dates in funnel object, sort them, then grab values to calculate improvement over time,
          // to maintain order of the dates in the object
          for (variant in funnelObject) {
            if (variant != baseline && variant != '$overall') {
              var abList = [],
                  totalVar = 0,
                  totalBase = 0,
                  convVar = 0,
                  convBase = 0;
              abObject[variant] = {};
              for (date in funnelObject[variant]) {
                abList.push(date);
              }
              abList.sort();
              for (var i in abList) {
                var date = abList[i];
                if ( totalVar == 0 && totalBase == 0 ) {
                  startDate[variant] = date;
                }
                totalVar += funnelObject[variant][date][1];
                convVar += funnelObject[variant][date][2];
                totalBase += funnelObject[baseline][date][1];
                convBase += funnelObject[baseline][date][2];
                var improve = (convVar/totalVar - convBase/totalBase)/(convBase/totalBase);
                abObject[variant][date] = improve;
              }
            }
          }
          var startDateList = [];
          for (variant in startDate) {
            startDateList.push(startDate[variant]);
          }
          startDateList.sort();
          startDate = startDateList[0];
          for (variant in abObject) {
            for (date in abObject[variant]) {
              if ( date < startDate || abObject[variant][date] == Infinity || abObject[variant][date] == NaN ) {
                delete abObject[variant][date];
              }
            }
          }
          function parseDate(str) {
            var mdy = str.split('-')
            return new Date(mdy[0], mdy[1]-1, mdy[2]);
          }
          function daydiff(first, second) {
            return (second-first)/(1000*60*60*24);
          }
          var duration = daydiff(parseDate(startDate), parseDate(today));

          $('.start.' + event).append('<p>Start Date: ' + startDate + '</p><p>Experiment Duration: ' + duration.toFixed(0) + ' days</p>');

          for (variant in tableObject) {
            if ( tableObject['Original version'] ) {
              var origTotal = tableObject['Original version']['*Experiment Viewed'],
                  origSuccess = tableObject['Original version'][conversionEvent];
            }
            else {
              var origTotal = 0,
                  origSuccess = 0;
            }
            var varTotal = tableObject[variant]['*Experiment Viewed'],
                varSuccess = tableObject[variant][conversionEvent];
            
            stats = calcStats(origTotal, origSuccess, varTotal, varSuccess);
            tableObject[variant]['~~Improvement'] = stats[0];
            tableObject[variant]['~Conversion'] += ' ' + stats[1];
            tableObject[variant]['~~~Chance to Beat Original'] = stats[2];
            if (stats[3] != '--') {
              tableObject[variant]['~~~Chance to Beat Original'] += ' (' + stats[3] + ')';
            }
            
            if (people.hasOwnProperty(variant)) {
              if (people[variant]['count'] != 0) {
                tableObject[variant]['~~~~Average First Payment'] = '$' + (people[variant]['first'] / people[variant]['count']).toFixed(2);
                tableObject[variant]['~~~~Average Lifetime Revenue'] = '$' + (people[variant]['lifetime'] / people[variant]['count']).toFixed(2);
              }
              else {
                tableObject[variant]['~~~~Average First Payment'] = '--';
                tableObject[variant]['~~~~Average Lifetime Revenue'] = '--';
              }
            }
            else if (variant == '$overall') {
              if (people['total']['count'] != 0) {
                tableObject[variant]['~~~~Average First Payment'] = '$' + (people['total']['first'] / people['total']['count']).toFixed(2);
                tableObject[variant]['~~~~Average Lifetime Revenue'] = '$' + (people['total']['lifetime'] / people['total']['count']).toFixed(2);
              }
              else {
                tableObject[variant]['~~~~Average First Payment'] = '--';
                tableObject[variant]['~~~~Average Lifetime Revenue'] = '--';
              }
            }
            else {
              tableObject[variant]['~~~~Average First Payment'] = '--';
              tableObject[variant]['~~~~Average Lifetime Revenue'] = '--';
            }
          }

          tableObject['$overall']['~~Improvement'] = 'N/A'
          tableObject['$overall']['~~~Chance to Beat Original'] = 'N/A'
          if (tableObject['Original version']) {
            tableObject['Original version']['~~Improvement'] = 'N/A'
            tableObject['Original version']['~~~Chance to Beat Original'] = 'N/A'
          
          }

          funnelSelects[event].MPChart('setData', abObject);
          tableSelects[event].MPTable('setData', tableObject);
          $('.improvement.' + event).show();
          $('.start.' + event).show();
          
        });
      }
      
      addExperiment();

      $('#people-prop-select').on('change', function() {
        if ( ($(this).MPSelect('value')).indexOf($('#event-prop-select').MPSelect('value')) > -1 ) {
          runQuery('a');
          runQuery('b');
        }
      });
      $('#event-prop-select').on('change', function() {
        if ( ($('#people-prop-select').MPSelect('value')).indexOf($(this).MPSelect('value')) > -1 ) {
          runQuery('a');
          runQuery('b');
        }
      });
      
      $('#conversion-event-a').on('change', function() {
        propValueSelects['a'] = undefined;
        runQuery('a');
        $('.where.a').css('display', 'inline-block');
        
        $('#conversion-prop-a').MPPropertySelect('setEvent', $(this).MPEventSelect('value')).css('display', 'inline-block');
        
      });
      $('#conversion-prop-a').on('change', function() {
        propValueSelects['a'] = undefined;
        runQuery('a');
        $('#conversion-prop-value-a').html('');
        
        // create dropdown that provides query options
        queries['a'] = $('.contains.a').MPSelect(queryOptions).css('display', 'inline-block');
        
        $('#conversion-prop-value-a').promise().done(function() {
          // create dropdown of property values for selected property
          propVals = { 
            items: [ 
              {label: '-- Select property value --', value: 'select'} 
              ]
          };
          eventParams = {
                event: $('#conversion-event-a').MPEventSelect('value'), 
                name: $('#conversion-prop-a').MPPropertySelect('value'), 
                limit: 255
              };
          MP.api.query('api/2.0/events/properties/values', eventParams).done(function(array) {
            for (property in array) {
              propVals.items.push({label: array[property], value: array[property]});
            }
            propValueSelects['a'] = $('#conversion-prop-value-a').MPSelect(propVals).css('display', 'inline-block');
          });
        });
      });
      $('.contains.a').on('change', function() {
        runQuery('a');
      });
      $('#conversion-prop-value-a').on('change', function() {
        runQuery('a');
      });
      
      $('#conversion-event-b').on('change', function() {
        propValueSelects['b'] = undefined;
        runQuery('b');
        $('.where.b').css('display', 'inline-block');

        $('#conversion-prop-b').MPPropertySelect('setEvent', $(this).MPEventSelect('value')).css('display', 'inline-block');
        
      });
      $('#conversion-prop-b').on('change', function() {
        propValueSelects['b'] = undefined;
        runQuery('b');
        $('#conversion-prop-value-b').html('');
        
        // create dropdown that provides query options
        queries['b'] = $('.contains.b').MPSelect(queryOptions).css('display', 'inline-block');
        
        $('#conversion-prop-value-b').promise().done(function() {
          // create dropdown of property values for selected property
          propVals2 = { 
            items: [ 
              {label: '-- Select property value --', value: 'select'} 
              ]
          };
          eventParams2 = {
                event: $('#conversion-event-b').MPEventSelect('value'), 
                name: $('#conversion-prop-b').MPPropertySelect('value'), 
                limit: 255
              };
          MP.api.query('api/2.0/events/properties/values', eventParams2).done(function(array) {
            for (property in array) {
              propVals2.items.push({label: array[property], value: array[property]});
            }
            propValueSelects['b'] = $('#conversion-prop-value-b').MPSelect(propVals2).css('display', 'inline-block');
          });
        });
      });
      $('.contains.b').on('change', function() {
        runQuery('b');
      });
      $('#conversion-prop-value-b').on('change', function() {
        runQuery('b');
      });
      
      $('#date-select').on('change', function() {
        runQuery('a');
        runQuery('b');
      });

    </script>
  </body>
</html>